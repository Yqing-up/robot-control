<template>
  <div class="container">
    <!-- È°∂ÈÉ®ÂØºËà™ -->
    <header class="header">
      <div class="nav-section">
        <button class="btn btn-back" @click="goBack">‚Üê ËøîÂõû‰∏ªÈ°µ</button>
        <h1 class="title">‰∏ãËÇ¢Á≥ªÁªüÊéßÂà∂‰∏≠ÂøÉ</h1>
      </div>
      <div class="header-controls">
        <!-- Áä∂ÊÄÅÊåáÁ§∫Âô®Â∑≤ÁßªÈô§ -->
        <div class="header-buttons">
          <button class="btn btn-small" @click="initializeCamera" :disabled="cameraLoading">
            {{ cameraLoading ? 'ËøûÊé•‰∏≠...' : 'Âà∑Êñ∞ÊëÑÂÉèÂ§¥' }}
          </button>
          <button class="btn btn-small" @click="exportMovementData">ÂØºÂá∫Êï∞ÊçÆ</button>
        </div>
      </div>
    </header>

    <main class="leg-main">
      <!-- ‰ΩøÁî®Â∑¶Âè≥Â∏ÉÂ±ÄÂÆπÂô® -->
      <div class="leg-layout-container">
        <!-- Â∑¶‰æßÊéßÂà∂Âå∫ -->
        <div class="leg-left-section">
          <!-- ‰∏ªÊéßÂà∂Âå∫ -->
          <section class="control-section">
            <div class="main-controls">
              <!-- Êú∫Âô®‰∫∫ÊéßÂà∂‰∏≠ÂøÉ -->
              <div class="robot-control-center">
                <div class="control-layout">
                  <!-- ÊëÑÂÉèÂ§¥ËßÜÈ¢ëÊµÅÂå∫Âüü - ‰∏äÊñπ -->
                  <div class="camera-section">
                    <div class="video-display">
                      <!-- ËßÜÈ¢ëÊ®°Âºè -->
                      <video
                        v-if="!useFallbackImage"
                        ref="cameraVideo"
                        class="camera-stream"
                        :src="cameraStreamUrl"
                        autoplay
                        muted
                        playsinline
                        controls
                        preload="none"
                        @loadstart="onVideoLoadStart"
                        @loadeddata="onVideoLoaded"
                        @play="onVideoPlay"
                        @pause="onVideoPause"
                        @ended="onVideoEnded"
                        @error="onVideoError"
                        @canplay="onVideoCanPlay"
                        @waiting="onVideoWaiting"
                      >
                        <div class="video-placeholder">
                          <div class="placeholder-icon">üìπ</div>
                          <div class="placeholder-text">ÊëÑÂÉèÂ§¥ÁîªÈù¢</div>
                          <div class="placeholder-status">{{ cameraStatus }}</div>
                        </div>
                      </video>

                      <!-- ÂõæÁâáÊ®°ÂºèÔºàMJPEGÊµÅÂ§áÁî®ÊñπÊ°àÔºâ -->
                      <img
                        v-else
                        ref="cameraImage"
                        class="camera-stream"
                        :src="cameraStreamUrl"
                        @load="onImageLoad"
                        @error="onImageError"
                        alt="ÊëÑÂÉèÂ§¥ÁîªÈù¢"
                      />
                      <div v-if="!cameraConnected" class="video-overlay">
                        <div class="overlay-content">
                          <div class="overlay-icon">üìπ</div>
                          <div class="overlay-text">ÊëÑÂÉèÂ§¥ÁîªÈù¢</div>
                          <div class="overlay-status">{{ cameraStatus }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="camera-controls">
                      <button class="camera-btn" @click="toggleCamera" :disabled="cameraLoading">
                        {{ cameraConnected ? 'Êñ≠ÂºÄÊëÑÂÉèÂ§¥' : 'ËøûÊé•ÊëÑÂÉèÂ§¥' }}
                      </button>
                      <button class="camera-btn" @click="toggleFullscreen" :disabled="!cameraConnected">
                        {{ isFullscreen ? 'üîç ÈÄÄÂá∫ÂÖ®Â±è' : 'üîç ÂÖ®Â±è' }}
                      </button>
                    </div>
                  </div>

                  <!-- ÊñπÂêëÊéßÂà∂Âå∫Âüü - ‰∏ãÊñπ -->
                  <div class="direction-section">
                    <div class="direction-pad-extended">
                      <!-- Â∑¶ÁßªÊåâÈíÆ -->
                      <button class="direction-btn side-btn left-move"
                              :class="{ active: currentDirection === 'left-move', disabled: isExecutingAction }"
                              :disabled="isExecutingAction"
                              @click="setDirection('left-move')"
                              data-direction="left-move">
                        <span class="arrow">‚Üê</span>
                        <span class="label">Â∑¶Áßª</span>
                      </button>

                      <!-- ‰∏≠Â§ÆÊéßÂà∂Âå∫Âüü -->
                      <div class="center-controls">
                        <button class="direction-btn forward"
                                :class="{ active: currentDirection === 'forward', disabled: isExecutingAction }"
                                :disabled="isExecutingAction"
                                @click="setDirection('forward')"
                                data-direction="forward">
                          <span class="arrow">‚Üë</span>
                          <span class="label">ÂâçËøõ</span>
                        </button>
                        <div class="middle-row">
                          <button class="direction-btn left"
                                  :class="{ active: currentDirection === 'left', disabled: isExecutingAction }"
                                  :disabled="isExecutingAction"
                                  @click="setDirection('left')"
                                  data-direction="left">
                            <span class="arrow">‚Ü∫</span>
                            <span class="label">Â∑¶ËΩ¨</span>
                          </button>
                          <button class="direction-btn stop emergency"
                                  :class="{ active: currentDirection === 'stop' }"
                                  @click="emergencyStop"
                                  data-direction="stop">
                            <span class="stop-icon">‚ñ†</span>
                            <span class="label">Á¥ßÊÄ•ÂÅúÊ≠¢</span>
                          </button>
                          <button class="direction-btn right"
                                  :class="{ active: currentDirection === 'right', disabled: isExecutingAction }"
                                  :disabled="isExecutingAction"
                                  @click="setDirection('right')"
                                  data-direction="right">
                            <span class="arrow">‚Üª</span>
                            <span class="label">Âè≥ËΩ¨</span>
                          </button>
                        </div>
                        <button class="direction-btn backward"
                                :class="{ active: currentDirection === 'backward', disabled: isExecutingAction }"
                                :disabled="isExecutingAction"
                                @click="setDirection('backward')"
                                data-direction="backward">
                          <span class="arrow">‚Üì</span>
                          <span class="label">ÂêéÈÄÄ</span>
                        </button>
                      </div>

                      <!-- Âè≥ÁßªÊåâÈíÆ -->
                      <button class="direction-btn side-btn right-move"
                              :class="{ active: currentDirection === 'right-move', disabled: isExecutingAction }"
                              :disabled="isExecutingAction"
                              @click="setDirection('right-move')"
                              data-direction="right-move">
                        <span class="arrow">‚Üí</span>
                        <span class="label">Âè≥Áßª</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- Âè≥‰æßÁõëÊéßÂå∫ -->
        <div class="leg-right-section">
          <!-- Áä∂ÊÄÅÁõëÊéßÂå∫ -->
          <section class="monitoring-section">
            <div class="monitor-grid">
              <!-- Âπ≥Ë°°Á≥ªÁªüÁõëÊéß -->
              <div class="monitor-panel balance-panel">
                <div class="panel-header">
                  <h3>Âπ≥Ë°°Á≥ªÁªü</h3>
                  <div class="leg-status-indicator online"></div>
                </div>
                <div class="balance-display">
                  <div class="balance-meter">
                    <div class="balance-indicator" :style="{ transform: `translate3d(calc(-50% + ${balance.tilt * 3}px), -50%, 0)` }"></div>
                    <div class="balance-scale">
                      <span>-30¬∞</span>
                      <span>0¬∞</span>
                      <span>+30¬∞</span>
                    </div>
                  </div>
                  <div class="balance-values">
                    <div class="balance-item">
                      <span class="label">ÂÄæÊñúËßíÂ∫¶</span>
                      <span class="value">{{ balance.tilt.toFixed(1) }}¬∞</span>
                    </div>
                    <div class="balance-item">
                      <span class="label">Á®≥ÂÆöÊÄß</span>
                      <span class="value">{{ balance.stability.toFixed(2) }}%</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ÁßªÂä®Áä∂ÊÄÅÁõëÊéß -->
              <div class="monitor-panel movement-panel">
                <div class="panel-header">
                  <h3>ÁßªÂä®Áä∂ÊÄÅ</h3>
                  <div class="leg-status-indicator online"></div>
                </div>
                <div class="movement-display">
                  <div class="position-info">
                    <div class="position-item">
                      <span class="label">XÂùêÊ†á</span>
                      <span class="value">{{ position.x.toFixed(1) }} m</span>
                    </div>
                    <div class="position-item">
                      <span class="label">YÂùêÊ†á</span>
                      <span class="value">{{ position.y.toFixed(1) }} m</span>
                    </div>
                    <div class="position-item">
                      <span class="label">ÊúùÂêë</span>
                      <span class="value">{{ heading }}¬∞</span>
                    </div>
                    <div class="position-item">
                      <span class="label">ÊÄªË∑ùÁ¶ª</span>
                      <span class="value">{{ totalDistance.toFixed(1) }} m</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Ê≠•ÊÄÅÈÄâÊã© -->
              <div class="monitor-panel gait-panel">
                <div class="panel-header">
                  <h3>Ê≠•ÊÄÅÊ®°Âºè</h3>
                  <div class="leg-status-indicator online"></div>
                </div>
                <div class="gait-selector">
                  <button class="gait-btn"
                          :class="{ active: currentGait === 'normal' }"
                          @click="setGait('normal')"
                          data-gait="normal">
                    <span class="gait-icon">üë£</span>
                    <span class="gait-name">Ê≠£Â∏∏Ë°åËµ∞</span>
                    <span class="gait-desc">Á®≥ÂÆöÂπ≥Ë°°</span>
                  </button>
                  <button class="gait-btn"
                          :class="{ active: currentGait === 'fast' }"
                          @click="setGait('fast')"
                          data-gait="fast">
                    <span class="gait-icon">‚ö°</span>
                    <span class="gait-name">Âø´ÈÄüÁßªÂä®</span>
                    <span class="gait-desc">È´òÊïàÁéá</span>
                  </button>
                  <button class="gait-btn"
                          :class="{ active: currentGait === 'precise' }"
                          @click="setGait('precise')"
                          data-gait="precise">
                    <span class="gait-icon">üéØ</span>
                    <span class="gait-name">Á≤æÁ°ÆÂÆö‰Ωç</span>
                    <span class="gait-desc">È´òÁ≤æÂ∫¶</span>
                  </button>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted, reactive } from 'vue'
import { useRouter } from 'vue-router'
import { movementApi } from '../api/movementApi.js'
import { cameraApi } from '../api/cameraApi.js'
// Â¶ÇÈúÄÁî®Âà∞Â∑•ÂÖ∑ÂáΩÊï∞ËØ∑Âú®Êú¨Êñá‰ª∂ÂÆûÁé∞

const router = useRouter()

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const isMoving = ref(false)
const currentDirection = ref('stop')
const currentGait = ref('normal')
const isExecutingAction = ref(false) // Êú∫Âô®‰∫∫ÊòØÂê¶Ê≠£Âú®ÊâßË°åÂä®‰Ωú

// ÊëÑÂÉèÂ§¥Áõ∏ÂÖ≥Êï∞ÊçÆ
const cameraConnected = ref(false)
const cameraLoading = ref(false)
const cameraStatus = ref('ÊëÑÂÉèÂ§¥Êú™ËøûÊé•')
const cameraStreamUrl = ref('') // ÊëÑÂÉèÂ§¥ÊµÅURL‰ªéAPIËé∑Âèñ
const cameraVideo = ref(null)
const cameraImage = ref(null)
const useFallbackImage = ref(true) // ÈªòËÆ§‰ΩøÁî®ÂõæÁâáÊ®°ÂºèÊòæÁ§∫MJPEGÊµÅ
const isFullscreen = ref(false) // ÂÖ®Â±èÁä∂ÊÄÅ

// ‰ΩøÁî®reactiveËÄåÈùûrefÊù•ÈÅøÂÖç‰∏çÂøÖË¶ÅÁöÑÂìçÂ∫îÂºèÊõ¥Êñ∞‰º†Êí≠
const position = reactive({ x: 0, y: 0 })
const heading = ref(0)
const totalDistance = ref(0)
const stepCount = ref(0)
const balance = reactive({
  tilt: 0, // ÂàùÂßãÂÄº‰∏∫0Â∫¶
  stability: 98
})
const runTime = ref(0)
const batteryLevel = ref(1.0)
const temperature = ref(45)

// Á≥ªÁªüÁä∂ÊÄÅ
const systemStatus = ref('online')
const statusText = ref('Á≥ªÁªüÂ∞±Áª™')

// Âä®ÁîªÂ∏ßID
let animationFrameId = null
let lastUpdateTime = 0
let isUpdating = false
let updateCount = 0

// ÊñπÊ≥ï
const goBack = () => {
  router.push('/')
}

// Ëé∑ÂèñÊñπÂêëÊ†áÁ≠æÁöÑËæÖÂä©ÂáΩÊï∞
const getDirectionLabel = (direction) => {
  return movementApi.getMovementLabel(direction)
}

// ËÆæÁΩÆÊñπÂêë
const setDirection = async (direction) => {
  // Ê£ÄÊü•ÊòØÂê¶Ê≠£Âú®ÊâßË°åÂä®‰Ωú
  if (isExecutingAction.value && direction !== 'stop') {
    console.warn('‚ö†Ô∏è Êú∫Âô®‰∫∫Ê≠£Âú®ÊâßË°åÂä®‰ΩúÔºåËØ∑Á≠âÂæÖÂÆåÊàêÂêéÂÜçÊìç‰Ωú')
    statusText.value = '‚ö†Ô∏è ËØ∑Á≠âÂæÖÂΩìÂâçÂä®‰ΩúÂÆåÊàê'
    // 1ÁßíÂêéÊÅ¢Â§çÁä∂ÊÄÅÊñáÊú¨
    setTimeout(() => {
      if (!isExecutingAction.value) {
        statusText.value = 'Á≥ªÁªüÂ∞±Áª™'
      }
    }, 1000)
    return
  }

  currentDirection.value = direction
  isMoving.value = direction !== 'stop'

  if (direction === 'stop') {
    statusText.value = 'Á≥ªÁªüÂ∞±Áª™'
  } else {
    statusText.value = `Ê≠£Âú®${getDirectionLabel(direction)}`
  }

  // Ë∞ÉÁî®ÂØπÂ∫îÁöÑÊú∫Âô®‰∫∫ÁßªÂä®API
  await executeMovement(direction)
}

// ÊâßË°åÊú∫Âô®‰∫∫ÁßªÂä®
const executeMovement = async (direction) => {
  if (direction === 'stop') {
    // ÂÅúÊ≠¢Êó∂‰∏çË∞ÉÁî®APIÔºåÂè™Êõ¥Êñ∞Áä∂ÊÄÅ
    return
  }

  // ËÆæÁΩÆÊâßË°åÁä∂ÊÄÅ‰∏∫trueÔºåÈîÅÂÆöÂÖ∂‰ªñÊåâÈíÆ
  isExecutingAction.value = true
  const actionName = getDirectionLabel(direction)
  console.log(`üîí ÈîÅÂÆöÊéßÂà∂ÊåâÈíÆÔºåÂºÄÂßãÊâßË°å${actionName}`)

  // Ë∞ÉÁî®API
  const response = await movementApi.executeMovement(direction)
  console.log('ÊâßË°åÁßªÂä®APIÂìçÂ∫î:', response)
  const result = response.data || response
  console.log('ÊèêÂèñÁöÑÊâßË°åÁßªÂä®Êï∞ÊçÆ:', result)

  // Êõ¥Êñ∞Áä∂ÊÄÅÊñáÊú¨
  if (result.success) {
    statusText.value = `‚úÖ ${result.action}ÂÆåÊàê`
    console.log(`‚úÖ ${result.action}ÊâßË°åÂÆåÊàêÔºåËß£ÈîÅÊéßÂà∂ÊåâÈíÆ`)

    // 2ÁßíÂêéÊÅ¢Â§ç‰∏∫Â∞±Áª™Áä∂ÊÄÅÂπ∂Ëß£ÈîÅÊåâÈíÆ
    setTimeout(() => {
      isExecutingAction.value = false
      if (currentDirection.value === 'stop') {
        statusText.value = 'Á≥ªÁªüÂ∞±Áª™'
      }
      console.log('üîì ÊéßÂà∂ÊåâÈíÆÂ∑≤Ëß£ÈîÅ')
    }, 2000)
  } else {
    statusText.value = `‚ùå ${result.action || actionName}Â§±Ë¥•: ${result.error}`
    console.log(`‚ùå ${result.action || actionName}ÊâßË°åÂ§±Ë¥•ÔºåËß£ÈîÅÊéßÂà∂ÊåâÈíÆ`)

    // Á´ãÂç≥Ëß£ÈîÅÊåâÈíÆÔºå3ÁßíÂêéÊÅ¢Â§çÁä∂ÊÄÅÊñáÊú¨
    isExecutingAction.value = false
    setTimeout(() => {
      statusText.value = 'Á≥ªÁªüÂ∞±Áª™'
    }, 3000)
    console.log('üîì ÊéßÂà∂ÊåâÈíÆÂ∑≤Ëß£ÈîÅ')
  }
}

// Á¥ßÊÄ•ÂÅúÊ≠¢
const emergencyStop = async () => {
  currentDirection.value = 'stop'
  isMoving.value = false
  statusText.value = 'Á¥ßÊÄ•ÂÅúÊ≠¢‰∏≠...'
  console.log('üö® Á¥ßÊÄ•ÂÅúÊ≠¢ - Âº∫Âà∂‰∏≠Êñ≠ÂΩìÂâçÂä®‰Ωú')

  // Á¥ßÊÄ•ÂÅúÊ≠¢Êó∂Á´ãÂç≥ËÆæÁΩÆÊâßË°åÁä∂ÊÄÅÔºåÈò≤Ê≠¢ÂÖ∂‰ªñÊìç‰Ωú
  isExecutingAction.value = true

  // Ë∞ÉÁî®Á¥ßÊÄ•ÂÅúÊ≠¢API
  const result = await movementApi.emergencyStop()

  // Êõ¥Êñ∞Áä∂ÊÄÅÊñáÊú¨
  if (result.success) {
    statusText.value = `‚úÖ ${result.action}ÂÆåÊàê`
    console.log(`‚úÖ ${result.action}ÊâßË°åÂÆåÊàê`)
  } else {
    statusText.value = `‚ùå ${result.action || 'Á¥ßÊÄ•ÂÅúÊ≠¢'}Â§±Ë¥•: ${result.error}`
    console.log(`‚ùå ${result.action || 'Á¥ßÊÄ•ÂÅúÊ≠¢'}ÊâßË°åÂ§±Ë¥•`)
  }

  // 2ÁßíÂêéÊÅ¢Â§ç‰∏∫Â∞±Áª™Áä∂ÊÄÅÂπ∂Ëß£ÈîÅÊåâÈíÆ
  setTimeout(() => {
    isExecutingAction.value = false
    statusText.value = 'Á≥ªÁªüÂ∞±Áª™'
    console.log('üîì Á¥ßÊÄ•ÂÅúÊ≠¢ÂÆåÊàêÔºåÊéßÂà∂ÊåâÈíÆÂ∑≤Ëß£ÈîÅ')
  }, 2000)
}

// ÊµãËØïÊëÑÂÉèÂ§¥ËøûÊé•
const testCameraConnection = async () => {
  return await cameraApi.testConnection()
}

// ÊëÑÂÉèÂ§¥ÊéßÂà∂ÂáΩÊï∞
const toggleCamera = async () => {
  cameraLoading.value = true

  try {
    if (cameraConnected.value) {
      // Êñ≠ÂºÄÊëÑÂÉèÂ§¥
      cameraStreamUrl.value = ''
      cameraConnected.value = false
      cameraStatus.value = 'ÊëÑÂÉèÂ§¥Â∑≤Êñ≠ÂºÄ'
      console.log('ÊëÑÂÉèÂ§¥Â∑≤Êñ≠ÂºÄ')
    } else {
      // ËøûÊé•ÊëÑÂÉèÂ§¥
      cameraStatus.value = 'Ê≠£Âú®ËøûÊé•ÊëÑÂÉèÂ§¥...'

      // ÊµãËØïÊëÑÂÉèÂ§¥ËøûÊé•
      const isConnectable = await testCameraConnection()

      if (isConnectable) {
        // ËÆæÁΩÆËßÜÈ¢ëÊµÅURL
        const streamUrl = cameraApi.getStreamUrl()
        cameraStreamUrl.value = streamUrl
        cameraConnected.value = true
        cameraStatus.value = 'ÊëÑÂÉèÂ§¥Â∑≤ËøûÊé•'
        console.log('ÊëÑÂÉèÂ§¥Â∑≤ËøûÊé•ÔºåËßÜÈ¢ëÊµÅURL:', streamUrl)
      } else {
        throw new Error('Êó†Ê≥ïËøûÊé•Âà∞ÊëÑÂÉèÂ§¥ÊúçÂä°')
      }
    }
  } catch (error) {
    console.error('ÊëÑÂÉèÂ§¥ËøûÊé•Â§±Ë¥•:', error)
    cameraStatus.value = `ËøûÊé•Â§±Ë¥•: ${error.message}`
    cameraConnected.value = false
    cameraStreamUrl.value = ''
  } finally {
    cameraLoading.value = false
  }
}

// ÂÆåÂñÑÁöÑÂÖ®Â±èÂäüËÉΩ
const toggleFullscreen = async () => {
  if (!cameraConnected.value) return

  try {
    if (isFullscreen.value) {
      // ÈÄÄÂá∫ÂÖ®Â±è
      if (document.exitFullscreen) {
        await document.exitFullscreen()
      } else if (document.webkitExitFullscreen) {
        await document.webkitExitFullscreen()
      } else if (document.mozCancelFullScreen) {
        await document.mozCancelFullScreen()
      } else if (document.msExitFullscreen) {
        await document.msExitFullscreen()
      }
      console.log('üîç ÈÄÄÂá∫ÂÖ®Â±èÊ®°Âºè')
    } else {
      // ËøõÂÖ•ÂÖ®Â±è - ÊîØÊåÅMJPEGÂíåËßÜÈ¢ëÊ®°Âºè
      const element = useFallbackImage.value ? cameraImage.value : cameraVideo.value

      if (element) {
        if (element.requestFullscreen) {
          await element.requestFullscreen()
        } else if (element.webkitRequestFullscreen) {
          await element.webkitRequestFullscreen()
        } else if (element.mozRequestFullScreen) {
          await element.mozRequestFullScreen()
        } else if (element.msRequestFullscreen) {
          await element.msRequestFullscreen()
        }
        console.log('üîç ËøõÂÖ•ÂÖ®Â±èÊ®°Âºè')
      }
    }
  } catch (error) {
    console.error('‚ùå ÂÖ®Â±èÊìç‰ΩúÂ§±Ë¥•:', error)
    cameraStatus.value = '‚ùå ÂÖ®Â±èÊìç‰ΩúÂ§±Ë¥•'
  }
}

const onVideoLoadStart = () => {
  console.log('üé• ËßÜÈ¢ëÂºÄÂßãÂä†ËΩΩ')
  cameraStatus.value = 'Ê≠£Âú®Âä†ËΩΩËßÜÈ¢ëÊµÅ...'
}

const onVideoError = (event) => {
  console.error('‚ùå ËßÜÈ¢ëÂä†ËΩΩÈîôËØØ:', event)

  // Ëé∑ÂèñÊõ¥ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
  const video = event.target
  if (video && video.error) {
    const errorCode = video.error.code
    const errorMessage = video.error.message
    console.error('üìπ ËßÜÈ¢ëÈîôËØØËØ¶ÊÉÖ:', {
      code: errorCode,
      message: errorMessage,
      src: video.src
    })

    // Ê†πÊçÆÈîôËØØ‰ª£Á†ÅÊèê‰æõÂÖ∑‰ΩìÁöÑÈîôËØØ‰ø°ÊÅØ
    let errorText = 'ËßÜÈ¢ëÂä†ËΩΩÂ§±Ë¥•'
    switch (errorCode) {
      case 1: // MEDIA_ERR_ABORTED
        errorText = 'ËßÜÈ¢ëÂä†ËΩΩË¢´‰∏≠Ê≠¢'
        break
      case 2: // MEDIA_ERR_NETWORK
        errorText = 'ÁΩëÁªúÈîôËØØÔºåÊó†Ê≥ïÂä†ËΩΩËßÜÈ¢ë'
        break
      case 3: // MEDIA_ERR_DECODE
        errorText = 'ËßÜÈ¢ëËß£Á†ÅÈîôËØØ'
        break
      case 4: // MEDIA_ERR_SRC_NOT_SUPPORTED
        errorText = 'ËßÜÈ¢ëÊ†ºÂºè‰∏çÊîØÊåÅÊàñÊ∫ê‰∏çÂèØÁî®'
        break
      default:
        errorText = `ËßÜÈ¢ëÈîôËØØ (‰ª£Á†Å: ${errorCode})`
    }

    cameraStatus.value = `‚ùå ${errorText}`
  } else {
    cameraStatus.value = '‚ùå ËßÜÈ¢ëÂä†ËΩΩÂ§±Ë¥•ÔºåÂéüÂõ†Êú™Áü•'
  }

  cameraConnected.value = false

  // 10ÁßíÂêéËá™Âä®ÈáçËØïËøûÊé•
  setTimeout(() => {
    if (!cameraConnected.value) {
      console.log('üîÑ Ëá™Âä®ÈáçËØïÊëÑÂÉèÂ§¥ËøûÊé•')
      cameraStatus.value = 'üîÑ Ê≠£Âú®ÈáçËØïËøûÊé•...'
      initializeCamera()
    }
  }, 10000)
}

// ËßÜÈ¢ëÂä†ËΩΩÊàêÂäü‰∫ã‰ª∂
const onVideoLoaded = () => {
  console.log('‚úÖ ËßÜÈ¢ëÊï∞ÊçÆÂä†ËΩΩÊàêÂäü')
  cameraStatus.value = 'üì∫ ËßÜÈ¢ëÊµÅÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê'
}

// ËßÜÈ¢ëÊí≠Êîæ‰∫ã‰ª∂
const onVideoPlay = () => {
  console.log('‚ñ∂Ô∏è ËßÜÈ¢ëÂºÄÂßãÊí≠Êîæ')
  cameraStatus.value = 'üé• ÊëÑÂÉèÂ§¥Ê≠£Â∏∏Â∑•‰Ωú'
  console.log('‚úÖ ËßÜÈ¢ëÊµÅËøûÊé•ÊàêÂäüÔºåÊëÑÂÉèÂ§¥Â∑•‰ΩúÊ≠£Â∏∏')
}

// ËßÜÈ¢ëÊöÇÂÅú‰∫ã‰ª∂
const onVideoPause = () => {
  console.log('‚è∏Ô∏è ËßÜÈ¢ëÊöÇÂÅú')
  cameraStatus.value = 'ËßÜÈ¢ëÊµÅÊöÇÂÅú'
}

// ËßÜÈ¢ëÁªìÊùü‰∫ã‰ª∂
const onVideoEnded = () => {
  console.log('‚èπÔ∏è ËßÜÈ¢ëÊµÅÁªìÊùü')
  cameraStatus.value = 'ËßÜÈ¢ëÊµÅÂ∑≤ÁªìÊùü'
}

// ËßÜÈ¢ëÂèØ‰ª•Êí≠Êîæ‰∫ã‰ª∂
const onVideoCanPlay = () => {
  console.log('‚úÖ ËßÜÈ¢ëÂèØ‰ª•ÂºÄÂßãÊí≠Êîæ')
  cameraStatus.value = 'üì∫ ËßÜÈ¢ëÂáÜÂ§áÂ∞±Áª™'
}

// ËßÜÈ¢ëÁ≠âÂæÖ‰∫ã‰ª∂
const onVideoWaiting = () => {
  console.log('‚è≥ ËßÜÈ¢ëÁºìÂÜ≤‰∏≠...')
  cameraStatus.value = '‚è≥ ËßÜÈ¢ëÁºìÂÜ≤‰∏≠...'
}

// ÂõæÁâáÂä†ËΩΩÊàêÂäü‰∫ã‰ª∂ÔºàMJPEGÊµÅÔºâ
const onImageLoad = () => {
  console.log('üì∫ MJPEGÊµÅÂä†ËΩΩÊàêÂäü')
  cameraStatus.value = 'üì∫ MJPEGÊëÑÂÉèÂ§¥Ê≠£Â∏∏Â∑•‰Ωú'
  cameraConnected.value = true
}

// ÂõæÁâáÂä†ËΩΩÈîôËØØ‰∫ã‰ª∂ÔºàMJPEGÊµÅÔºâ
const onImageError = (event) => {
  console.log('‚ùå MJPEGÊµÅÂä†ËΩΩÂ§±Ë¥•:', event)
  cameraStatus.value = '‚ùå MJPEGÊµÅÂä†ËΩΩÂ§±Ë¥•ÔºåÊ≠£Âú®ÈáçËØï...'
  cameraConnected.value = false

  // 5ÁßíÂêéËá™Âä®ÈáçËØï
  setTimeout(() => {
    if (!cameraConnected.value && cameraStreamUrl.value) {
      console.log('üîÑ Ëá™Âä®ÈáçËØïMJPEGÊµÅËøûÊé•')
      // ÈÄöËøáÈáçÊñ∞ËÆæÁΩÆsrcÊù•Ëß¶ÂèëÈáçÊñ∞Âä†ËΩΩ
      const url = cameraStreamUrl.value
      cameraStreamUrl.value = ''
      setTimeout(() => {
        cameraStreamUrl.value = url
      }, 100)
    }
  }, 5000)
}

// ÂàáÊç¢ÊòæÁ§∫Ê®°Âºè
const toggleDisplayMode = () => {
  useFallbackImage.value = !useFallbackImage.value
  console.log(`üîÑ ÂàáÊç¢ÊòæÁ§∫Ê®°Âºè: ${useFallbackImage.value ? 'MJPEGÊ®°Âºè' : 'ËßÜÈ¢ëÊ®°Âºè'}`)
  cameraStatus.value = `üîÑ ÂàáÊç¢Âà∞${useFallbackImage.value ? 'MJPEG' : 'ËßÜÈ¢ë'}Ê®°Âºè...`

  if (cameraStreamUrl.value) {
    // ÈáçÊñ∞ËÆæÁΩÆÊ∫ê‰ª•Ëß¶ÂèëÈáçÊñ∞Âä†ËΩΩ
    const url = cameraStreamUrl.value
    cameraStreamUrl.value = ''
    setTimeout(() => {
      cameraStreamUrl.value = url
    }, 100)
  }
}

// ËØäÊñ≠ËßÜÈ¢ëÊµÅÂäüËÉΩ
const diagnoseVideoStream = async () => {
  console.log('üîç ÂºÄÂßãËØäÊñ≠ËßÜÈ¢ëÊµÅ...')
  cameraStatus.value = 'üîç Ê≠£Âú®ËØäÊñ≠ËßÜÈ¢ëÊµÅ...'

  try {
    const diagnosis = await cameraApi.diagnoseVideoStream()

    if (diagnosis.overall) {
      cameraStatus.value = '‚úÖ ËßÜÈ¢ëÊµÅËØäÊñ≠ÈÄöËøá'
      console.log('‚úÖ ËßÜÈ¢ëÊµÅËØäÊñ≠ÂÆåÊàêÔºåÊâÄÊúâÊµãËØïÈÄöËøá')
    } else {
      cameraStatus.value = '‚ùå ËßÜÈ¢ëÊµÅËØäÊñ≠Â§±Ë¥•'
      console.log('‚ùå ËßÜÈ¢ëÊµÅËØäÊñ≠Â§±Ë¥•:', diagnosis)
    }

    // 3. Ê£ÄÊü•ÂìçÂ∫îÂ§¥
    const headers = {}
    getResponse.headers.forEach((value, key) => {
      headers[key] = value
    })
    console.log('üìã ÂìçÂ∫îÂ§¥‰ø°ÊÅØ:', headers)

    // 4. Ê£ÄÊü•ËßÜÈ¢ëÂÖÉÁ¥†Áä∂ÊÄÅ
    const video = cameraVideo.value
    if (video) {
      console.log('üì∫ ËßÜÈ¢ëÂÖÉÁ¥†Áä∂ÊÄÅ:', {
        src: video.src,
        readyState: video.readyState,
        networkState: video.networkState,
        error: video.error,
        paused: video.paused,
        ended: video.ended
      })
    }

    cameraStatus.value = '‚úÖ ËØäÊñ≠ÂÆåÊàêÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞Êó•Âøó'

  } catch (error) {
    console.error('‚ùå ËØäÊñ≠ËøáÁ®ã‰∏≠Âá∫Èîô:', error)
    cameraStatus.value = `‚ùå ËØäÊñ≠Â§±Ë¥•: ${error.message}`
  }
}

// ËÆæÁΩÆÊ≠•ÊÄÅÊ®°Âºè
const setGait = (gait) => {
  currentGait.value = gait
  console.log('Ê≠•ÊÄÅÊ®°ÂºèËÆæÁΩÆ‰∏∫:', gait)
}



const resetSystem = () => {
  currentDirection.value = 'stop'
  currentGait.value = 'normal'
  isMoving.value = false
  position.value = { x: 0, y: 0 }
  heading.value = 0
  totalDistance.value = 0
  stepCount.value = 0
  console.log('Á≥ªÁªüÂ∑≤ÈáçÁΩÆ')
}

const exportMovementData = () => {
  const data = {
    position: position.value,
    heading: heading.value,
    totalDistance: totalDistance.value,
    stepCount: stepCount.value,
    currentGait: currentGait.value,
    balance: balance.value,
    runTime: runTime.value,
    batteryLevel: batteryLevel.value,
    temperature: temperature.value,
    systemStatus: systemStatus.value
  }

  systemUtils.exportMovementData(data)
}

// ÈîÆÁõòÊéßÂà∂
const handleKeyDown = async (event) => {
  switch (event.key.toLowerCase()) {
    case 'w':
    case 'arrowup':
      await setDirection('forward')
      break
    case 's':
    case 'arrowdown':
      await setDirection('backward')
      break
    case 'a':
    case 'arrowleft':
      await setDirection('left')
      break
    case 'd':
    case 'arrowright':
      await setDirection('right')
      break
    case 'q':
      await setDirection('left-move')
      break
    case 'e':
      await setDirection('right-move')
      break
    case ' ':
      event.preventDefault()
      await emergencyStop()
      break
  }
}

const handleKeyUp = async (event) => {
  // ÊùæÂºÄÊåâÈîÆÊó∂ÂÅúÊ≠¢ÁßªÂä®ÔºàÈô§‰∫ÜÁ©∫Ê†ºÈîÆÔºâ
  if (event.key !== ' ') {
    await setDirection('stop')
  }
}

// Ê®°ÊãüÊï∞ÊçÆÊõ¥Êñ∞ - ‰ΩøÁî®requestAnimationFrameÊõø‰ª£setInterval
const startMonitoring = () => {
  // ÂàùÂßãÂåñÊó∂Èó¥
  lastUpdateTime = performance.now()
  isUpdating = true

  // ÂàõÂª∫Âπ≥ÊªëÁöÑÊõ¥Êñ∞ÂáΩÊï∞
  const updateFrame = (timestamp) => {
    if (!isUpdating) return

    // ËÆ°ÁÆóÁªèËøáÁöÑÊó∂Èó¥ÔºàÊØ´ÁßíÔºâ
    const elapsed = timestamp - lastUpdateTime

    // ÊéßÂà∂Êõ¥Êñ∞È¢ëÁéáÔºåÊØè200msÊõ¥Êñ∞‰∏ÄÊ¨°Êï∞ÊçÆ
    if (elapsed > 200) {
      updateCount++

      // Âπ≥Ë°°Á≥ªÁªüÊï∞ÊçÆ - ‰ΩøÁî®Âπ≥ÊªëÁöÑÂèòÂåñÁÆóÊ≥ï
      // ‰ΩøÁî®Êõ¥Â∞èÊõ¥Âπ≥ÊªëÁöÑÂèòÂåñÈáè
      const tiltChange = (Math.random() - 0.5) * 0.3 // Êõ¥Â∞èÁöÑÂèòÂåñ
      let newTilt = balance.tilt + tiltChange

      // Ê®°Êãü‰∏ÄÁßçËá™ÁÑ∂ÁöÑÂπ≥Ë°°ÊÅ¢Â§çÊïàÊûú - Âêë0ÂõûÂΩí
      newTilt = newTilt * 0.95 // ÁºìÊÖ¢Âêë‰∏≠ÂøÉ‰ΩçÁΩÆÈù†Ëøë

      // ÈôêÂà∂Âú®ÂêàÁêÜËåÉÂõ¥ÂÜÖ
      newTilt = Math.max(-5, Math.min(5, newTilt))

      // ‰øùÁïô1‰ΩçÂ∞èÊï∞ÔºåÂáèÂ∞ëÈ¢ëÁπÅÂæÆÂ∞èÊõ¥Êñ∞
      balance.tilt = parseFloat(newTilt.toFixed(1))

      // Á®≥ÂÆöÊÄßÂè™‰ΩøÁî®ËæÉÂ∞èÁöÑÂèòÂåñÔºåÂπ∂Á´ãÂç≥Ê†ºÂºèÂåñ‰∏∫2‰ΩçÂ∞èÊï∞
      const stabilityChange = (Math.random() - 0.5) * 0.1
      let newStability = Math.max(95, Math.min(99, balance.stability + stabilityChange))
      balance.stability = parseFloat(newStability.toFixed(2)) // Áõ¥Êé•‰øùÁïô2‰ΩçÂ∞èÊï∞ÔºåÈÅøÂÖçÊòæÁ§∫ËøáÂ§öÂ∞èÊï∞‰Ωç

      // Âè™ÊúâÈúÄË¶ÅÊõ¥Êñ∞ÁöÑÊï∞ÊçÆÊâçÂú®ËøôÈáåÊõ¥Êñ∞
      // Â¶ÇÊûúÊ≠£Âú®ÁßªÂä®ÔºåÊõ¥Êñ∞‰ΩçÁΩÆ
      if (isMoving.value && currentDirection.value !== 'stop') {
        const speed = 1.0 // Âõ∫ÂÆöÈÄüÂ∫¶ 1.0 m/s
        const deltaTime = 0.1 // 100ms

        switch (currentDirection.value) {
          case 'forward':
            position.y += speed * deltaTime
            break
          case 'backward':
            position.y -= speed * deltaTime
            break
          case 'left':
            heading.value = (heading.value - 5) % 360
            break
          case 'right':
            heading.value = (heading.value + 5) % 360
            break
          case 'left-move':
            position.x -= speed * deltaTime
            break
          case 'right-move':
            position.x += speed * deltaTime
            break
        }

        stepCount.value++
        totalDistance.value += speed * deltaTime
      }

      // Âè™Âú®ÊØè10Ê¨°Êõ¥Êñ∞ÊâçÂ§ÑÁêÜËøô‰∫õ‰∏çÂ§™ÈáçË¶ÅÁöÑÊï∞ÊçÆÔºåÂáèÂ∞ëÈ°µÈù¢ÈáçÁªò
      if (updateCount % 10 === 0) {
        // Êõ¥Êñ∞ËøêË°åÊó∂Èó¥
        runTime.value++

        // Ê®°ÊãüÁîµÊ±†Ê∂àËÄó
        if (isMoving.value) {
          batteryLevel.value = Math.max(0, batteryLevel.value - 0.001)
        }

        // Ê®°ÊãüÊ∏©Â∫¶ÂèòÂåñ
        temperature.value = Math.round((40 + Math.random() * 10) * 10) / 10 // ‰øùÁïô1‰ΩçÂ∞èÊï∞
      }

      lastUpdateTime = timestamp
    }

    // ÁªßÁª≠‰∏ã‰∏ÄÂ∏ß
    animationFrameId = requestAnimationFrame(updateFrame)
  }

  // ÂºÄÂßãÂä®ÁîªÂæ™ÁéØ
  animationFrameId = requestAnimationFrame(updateFrame)

  // ËøîÂõû‰∏Ä‰∏™ÂÅúÊ≠¢ÂáΩÊï∞
  return () => {
    isUpdating = false
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId)
    }
  }
}

// ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
const saveToLocalStorage = () => {
  const data = {
    position: position.value,
    heading: heading.value,
    totalDistance: totalDistance.value,
    stepCount: stepCount.value,
    currentGait: currentGait.value,
    runTime: runTime.value,
    batteryLevel: batteryLevel.value
  }
  localStorage.setItem('legSystemData', JSON.stringify(data))
}

// ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩ
const loadFromLocalStorage = () => {
  const savedData = localStorage.getItem('legSystemData')
  if (savedData) {
    try {
      const data = JSON.parse(savedData)
      position.value = data.position || { x: 0, y: 0 }
      heading.value = data.heading || 0
      totalDistance.value = data.totalDistance || 0
      stepCount.value = data.stepCount || 0
      currentGait.value = data.currentGait || 'normal'
      runTime.value = data.runTime || 0
      batteryLevel.value = data.batteryLevel || 85
    } catch (error) {
      console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error)
    }
  }
}

// ÂàùÂßãÂåñÊëÑÂÉèÂ§¥ËøûÊé•
const initializeCamera = async () => {
  try {
    console.log('üé• Ê≠£Âú®ÂàùÂßãÂåñÊëÑÂÉèÂ§¥ËøûÊé•...')
    cameraLoading.value = true
    cameraStatus.value = 'Ê≠£Âú®ÂàùÂßãÂåñÊëÑÂÉèÂ§¥...'

    // ÊµãËØïÊëÑÂÉèÂ§¥ËøûÊé•
    const streamUrl = cameraApi.getStreamUrl()
    console.log('üîç ÊµãËØïÊëÑÂÉèÂ§¥ËøûÊé• (ÈÄöËøá‰ª£ÁêÜ):', streamUrl)
    console.log('üîç ÂÆûÈôÖÁõÆÊ†áÂú∞ÂùÄ: http://192.168.0.116:5001/api/video/raw_video_feed')
    const isConnectable = await testCameraConnection()

    if (isConnectable) {
      // Ëá™Âä®ËøûÊé•ÊëÑÂÉèÂ§¥
      console.log('‚úÖ ÊëÑÂÉèÂ§¥ÊúçÂä°ÂèØÁî®ÔºåÂºÄÂßãËøûÊé•ËßÜÈ¢ëÊµÅ')
      cameraStreamUrl.value = streamUrl
      cameraConnected.value = true
      cameraStatus.value = 'ÊëÑÂÉèÂ§¥ËøûÊé•ÊàêÂäüÔºåÊ≠£Âú®Âä†ËΩΩËßÜÈ¢ëÊµÅ...'
      console.log('üé• ÊëÑÂÉèÂ§¥Ëá™Âä®ËøûÊé•ÊàêÂäüÔºåËßÜÈ¢ëÊµÅURL:', streamUrl)
      console.log('üì∫ Á≠âÂæÖËßÜÈ¢ëÊµÅÂä†ËΩΩÂÆåÊàê...')
    } else {
      cameraStatus.value = 'ÊëÑÂÉèÂ§¥ÊúçÂä°‰∏çÂèØÁî®ÔºåËØ∑Ê£ÄÊü•ÊúçÂä°Âô®'
      console.log('‚ùå ÊëÑÂÉèÂ§¥ÊúçÂä°‰∏çÂèØÁî®')
    }
  } catch (error) {
    console.error('‚ùå ÊëÑÂÉèÂ§¥ÂàùÂßãÂåñÂ§±Ë¥•:', error)
    cameraStatus.value = `ÊëÑÂÉèÂ§¥ÂàùÂßãÂåñÂ§±Ë¥•: ${error.message}`
  } finally {
    cameraLoading.value = false
  }
}

// ÂÖ®Â±èÁä∂ÊÄÅÁõëÂê¨Âô®
const setupFullscreenListeners = () => {
  const handleFullscreenChange = () => {
    isFullscreen.value = !!(
      document.fullscreenElement ||
      document.webkitFullscreenElement ||
      document.mozFullScreenElement ||
      document.msFullscreenElement
    )
    console.log('üîç ÂÖ®Â±èÁä∂ÊÄÅÂèòÂåñ:', isFullscreen.value ? 'Â∑≤ËøõÂÖ•ÂÖ®Â±è' : 'Â∑≤ÈÄÄÂá∫ÂÖ®Â±è')
  }

  // Ê∑ªÂä†ÂÖ®Â±èÁä∂ÊÄÅÂèòÂåñÁõëÂê¨Âô®
  document.addEventListener('fullscreenchange', handleFullscreenChange)
  document.addEventListener('webkitfullscreenchange', handleFullscreenChange)
  document.addEventListener('mozfullscreenchange', handleFullscreenChange)
  document.addEventListener('MSFullscreenChange', handleFullscreenChange)

  // ËøîÂõûÊ∏ÖÁêÜÂáΩÊï∞
  return () => {
    document.removeEventListener('fullscreenchange', handleFullscreenChange)
    document.removeEventListener('webkitfullscreenchange', handleFullscreenChange)
    document.removeEventListener('mozfullscreenchange', handleFullscreenChange)
    document.removeEventListener('MSFullscreenChange', handleFullscreenChange)
  }
}

onMounted(() => {
  console.log('‰∏ãËÇ¢Á≥ªÁªüÁªÑ‰ª∂Â∑≤ÊåÇËΩΩ')
  loadFromLocalStorage()

  // Ê∑ªÂä†ÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨
  document.addEventListener('keydown', handleKeyDown)
  document.addEventListener('keyup', handleKeyUp)

  // ËÆæÁΩÆÂÖ®Â±èÁä∂ÊÄÅÁõëÂê¨Âô®
  const cleanupFullscreenListeners = setupFullscreenListeners()

  // ÂºÄÂßãÁõëÊéß
  const stopMonitoring = startMonitoring()

  // ÂàùÂßãÂåñÊëÑÂÉèÂ§¥
  initializeCamera()

  // ÂÆöÊúü‰øùÂ≠òÊï∞ÊçÆ
  const saveInterval = setInterval(saveToLocalStorage, 30000)

  onUnmounted(() => {
    console.log('‰∏ãËÇ¢Á≥ªÁªüÁªÑ‰ª∂Â∑≤Âç∏ËΩΩ')
    document.removeEventListener('keydown', handleKeyDown)
    document.removeEventListener('keyup', handleKeyUp)
    cleanupFullscreenListeners() // Ê∏ÖÁêÜÂÖ®Â±èÁõëÂê¨Âô®
    stopMonitoring() // ÂÅúÊ≠¢Âä®ÁîªÂ∏ß
    clearInterval(saveInterval)
    saveToLocalStorage() // ÊúÄÂêé‰øùÂ≠ò‰∏ÄÊ¨°
  })
})
</script>

<style>
@import '../assets/leg-system-new.css';
</style>
